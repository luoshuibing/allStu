# 不屈日记

# 分布式事务

CAP定理
* Consistency(一致性)
* Avaiolability(可用性)
* Partition tolerance(分区容错性)在整个系统出现分区时，整个系统也要堆外提供服务

BASE理论
* Basically Available（基本可用）：分布式系统在出现故障时，允许部分可用性，即保证核心可用
* Soft State（软状态）：在一定时间内，允许出现中间状态，比如临时的不一致状态
* Eventually Consistent（最终一致性）：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致

Seata架构
* TC-事务协调者：维护全局和分支事物的状态，协调全局事务提交或回滚
* TM-事务管理器：定义全局事务的范围、开始全局事务、提交或回滚全局事务
* RM-资源管理器：管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事物的状态，并驱动分支事物的提交或回滚

Seata提供了四种分布式事务
* XA模式：强一致性分阶段事务模型，牺牲了一定的可用性，无业务侵入
* TCC模式：最终一致性的分阶段事务模型，有业务侵入
* AT模式：最终一致性的分阶段事务模式，无业务侵入，也是seata的默认模式
* SAGA模式：长事务模式，有业务侵入

XA模式的优点
* 事物的强一致性，满足ACID原则
* 常用数据库都支持，实现简单，并且没有代码侵入

XA模式的缺点
* 因为一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差
* 依赖关系型数据库实现事实

AT模式的优点
* 一阶段完成直接提交事务，释放数据库资源，性能比较好
* 利用全局锁完成读写隔离
* 没有代码侵入，框架自动完成回滚和提交

AT模式的缺点：
* 两阶段之间属于软状态，属于最终一致
* 框架的快照功能会影响性能，但比XA模式要好很多

TCC模式
* Try:资源检查和预留
* Confirm：业务执行和提交
* Cancel：预留资源的释放

TCC模式优点
* 一阶段完成直接提交事务，释放数据库资源，性能好
* 相比AT模型，无需生成快照，无需使用全局锁，性能最强
* 不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库

TCC模式缺点
* 有代码侵入
* 软状态，事务是最终一致
* 需要考虑confirm和cancel的失败情况，做好幂等处理


Saga模式优点：
* 事务参与者可以基于事件驱动实现异步调用，吞吐高
* 一阶段直接提交事务，无锁，性能好
* 不用编写TCC中的三个阶段，实现简单

Saga模式缺点：
* 软状态持续时间不确定，时效性差
* 没有锁，没有事务隔离，会有脏写

模式对比

表头  | XA              | AT|TCC|SAGA
---- |-----------------| ------|----|----
一致性  | 强一致             | 弱一致|弱一致|最终一致
隔离性  | 完全隔离            | 基于全局锁隔离|基于资源预留隔离|无隔离
代码侵入  | 无               | 无|有，要编写三个接口|有，要编写状态机
性能  | 差               | 好|非常好|非常好
场景  | 对一致性、隔离性有高要求的业务 | 基于关系型数据库的大多数分布式事务场景都可以|对性能要求高的事务|业务流程长、业务流程多，参与者包含其他公司和遗留系统服务，无法提供TCC模式要求的三个接口






















