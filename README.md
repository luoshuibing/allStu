# 不屈日记

雪崩问题
* 超时处理，设定超时时间
* 舱壁模式：限定每个业务能使用的线程数，避免耗尽整个tomcat的资源
* 熔断降级：由断路器统计业务执行的异常比例，如果超出阈值则会熔断该业务，拦截访问该业务的一切请求
* 流量控制：限制业务访问的QPS，避免服务因流量的突增而故障

服务保护技术对比

表头  | Sentinel                        | Hystrix
---- |---------------------------------| ------
 隔离策略 | 信号量隔离                           | 线程池隔离、信号量隔离
熔断降级策略  | 基于慢调用比例或异常比例                    | 基于失败比例
实时指标实现  | 滑动窗口                            | 滑动窗口
规则配置  | 支持多种数据源                         | 支持多种数据源
扩展性  | 多个扩展点                           | 插件的形式
基于注解的支持  | 支持                              | 支持
限流  | 基于QPS                           | 有限的支持
流量整形  | 支持慢启动、匀速排队模式                    | 不支持
系统自适应保护  | 支持                              | 不支持
控制台  | 开箱即用、可配置规则、查看秒级监控、机器发现          | 不完善
常见框架的适配  | Servlet、Spring Cloud、Dubbo、gRpc | Servlet、Spring Cloud Netflix


![img.png](img.png)


流控模式

在添加限流规则时，点击高级选项
* 直接：统计当前资源，触发阈值时对当前资源直接限流。一个资源
* 关联：统计当前资源相关的另一个资源，触发阈值时，对当前资源限流。两个资源
* 链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流。三个资源

流控效果是指请求打到流控阈值时应该采取的措施。
* 快速失败：打到阈值后，新的请求会立即拒绝并抛出FlowException异常。
* warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值
* 排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长。


sentinel支持的雪崩解决方案
* 线程隔离
* 降级熔断


线程隔离
* 线程池隔离
* 信号量隔离

信号量隔离
* 优点：轻量级，无额外开销
* 缺点：不支持主动超时，不支持异步调用
* 场景：高扇出、高频调用

线程池隔离
* 优点：支持主动超时，支持异步调用
* 缺点：线程的额外开销比较大
* 场景：低扇出

熔断降级

熔断降级是解决雪崩问题的重要手段。其思路是由断路器统计服务调用的异常比例、慢请求比例，如果超出阈值则会熔断该服务。即拦截访问该服务的一切请求而当服务恢复时，断路器会放行该服务的请求。

![img_1.png](img_1.png)


sentinel熔断降级的策略
* 慢调用比例：超过指定时长的调用为慢调用，统计单位时长内慢调用的比例，超过阈值则熔断
* 异常比例：统计单位时长内异常调用的比例，超过阈值则熔断
* 异常数：统计单位时长内异常调用的次数，超过阈值则熔断






































